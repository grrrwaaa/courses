<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <script src="al.js"></script>
    <script>

var mat3 = draw2D.gl.mat3;
var glvec2 = draw2D.gl.vec2;
var glvec3 = draw2D.gl.vec3;

function pose() {
	this.mat = mat3.create();
	this.inverse = mat3.create();
	
	pose.prototype.update.apply(this, arguments);
}

pose.prototype.global = function(v) {
	return glvec2.transformMat3(new vec2(), v, this.mat);
}

pose.prototype.local = function(v) {
	return glvec2.transformMat3(new vec2(), v, this.inverse);
}

pose.prototype.update = function(translate, rotate, scale) {
	var m = this.mat;
	mat3.identity(m);
 	if (typeof translate == "object") {
 		mat3.translate(m, m, translate);
 	}
 	if (typeof rotate == "number") {
 		mat3.rotate(m, m, rotate);
 	} else if (typeof rotate == "object") {
 		mat3.rotate(m, m, vec2.angle(rotate));
 	} 	
	if (typeof scale == "number") {
		mat3.scale(m, m, [scale, scale]);
	} else if (typeof scale == "object") {
		mat3.scale(m, m, scale);
 	}
 	mat3.invert(this.inverse, this.mat);
	return this;
};


///////////////////////////

var sugar = new field2D(64);
function reset_sugar() {
	sugar.set(function(x, y) { return random(); });
	sugar.diffuse(sugar.clone(), sugar.width, 10);
	sugar.normalize();
}
reset_sugar();

var agents = [];
for (var i=0; i<40; i++) {
	agents.push({
		pos: new vec2(random(), random()),
		vel: vec2.random(0.001),
		size: 0.02,
		sense: 0,
	});
}

function update() {
	for (var a of agents) {
		var sense = sugar.sample(a.pos);
		var change = sense - a.sense;
		if (change < 0) {
			a.vel.rotate(3*(random()-0.5)).len(0.002);
		} else {
			a.vel.rotate(0.1*(random()-0.5)).len(0.008);
		}	
		// interpolate:
		a.sense += 0.1*(sense - a.sense);
		
		// locomotion

		a.pos.add(a.vel).wrap(1);
	}
}
  
function draw() {
  sugar.draw();
  
  for (var a of agents) {
  	draw2D.push().translate(a.pos).rotate(a.vel).scale(a.size);
  	draw2D.color(a.sense, 1-a.sense, 0.5)
  		.rect().circle([0.5, 0]).circle([-0.5, 0]);
  	draw2D.color("yellow")
  		.rect([0.5, 0.2], 0.2)
  		.rect([0.5,-0.2], 0.2);
  	draw2D.pop();
  }
}

// handle mouse events
function mouse(e, pt) {
	if (e == "down") reset_sugar();
}

// handle key events (must click on canvas first)
function key(e, k) {}
    </script>
  </body>
</html>