<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <script src="al.js"></script>
    <script>
    
var angle = Math.PI/3;
var scale = 3/2;

function make_turtle() {
	return {
		pos: new vec2(),
		dir: new vec2(1, 0),
	};
}
function turtle_copy(t) {
	return {
		pos: t.pos.clone(),
		dir: t.dir.clone(),
	};
}

function turtle_interpret(t, str, lines) {
	var i=0;
	while (i<str.length) {
		var c = str.substr(i, 1);
		if (c == "F") {
			var p2 = t.pos.clone().add(t.dir);
			lines.push({ from: t.pos.clone(), to: p2.clone() });
			t.pos = p2;
		} else if (c == "+") {
			t.dir.rotate(angle);
		} else if (c == "-") {
			t.dir.rotate(-angle);
		} else if (c == "*") {
			t.dir.mul(scale);
		} else if (c == "/") {
			t.dir.div(scale);
		} else if (c == "[") {
			var t1 = turtle_copy(t);
			i += turtle_interpret(t1, str.substr(i+1), lines);
		} else if (c == "]") {
			return i+1;
		}
		i++;
	}
}

var str = "F+F--F+F";
var lines = [];

turtle_interpret(make_turtle(), str, lines);

var rules = {
	"--": "-[/F+F--F+F]-",
};

function lsystem_interpret(str) {
	var res = "";
	for (var i=0; i<str.length; i++) {
		// assume by default that the next character will not be replaced:
		var replacement = str.substr(i, 1);
		// but try to match a rule:
		for (k in rules) {
			// does this match?
			if (k == str.substr(i, k.length)) {
				// then get the new replacement:
				replacement = rules[k];
				break;	// no need to check more rules
			}
		}
		res += replacement;
	}
	// convert result into a string:
	return res; 
}

t = now;
function update() {
	if (now - t > 1) {
		if (str.length > 1000) {
			str = "F+F--F+F";
		} else {
			str = lsystem_interpret(str);
			lines = [];
			turtle_interpret(make_turtle(), str, lines);
			write(str);
			t = now;
		}
	}	
}

function draw() {
	draw2D.translate(0.5, 0.5).scale(0.04);
	for (var l of lines) {
		draw2D.line(l.from, l.to);
	}
}

    </script>
  </body>
</html>