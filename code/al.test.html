<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <script src="al.js"></script>
    <script>


///////////////////////////

var food_phero = new field2D(128);
var food_phero_old = food_phero.clone();

// create a field of sugar concentrations
var sugar = new field2D(128);
// fill it:
function reset_sugar() {
  // clear it:
  sugar.set(0);

  // add some randomized points:
	for (var i=0; i<10; i++) {
    var p = vec2.random().add(1).mul(0.5);
    sugar.deposit(random(8), p);
  }
  // blur it
  sugar.diffuse(sugar.clone(), sugar.width, 150);
  // fit to 0..1 range
  sugar.normalize();
  // threshold it:
  sugar.map(function(v) { 
  	return v > 0.1 ? 1 : 0;
  });
}
reset_sugar();
// click to reset environment:
function mouse(e, pt) {
	if (e == "down") reset_sugar();
}

// create a home:
var nest = {
  pos: new vec2(0.5, 0.5),
  size: 0.1
}

var agents = [];
for (var i=0; i<40; i++) {
	agents.push({
		pos: new vec2(random(), random()),
		vel: vec2.random(0.001),
		size: 0.02,
    // stored recollection of previous sense
		sense_memory: 0.5,
	});
}

function update() {
	// fields:
	var tmp = food_phero_old;
	food_phero_old = food_phero;
	food_phero = tmp;
	
	
	food_phero.diffuse(food_phero_old, 0.01).mul(0.995);


	for (var a of agents) {
    // get the sugar level at this location:
		var sense = Math.max(0, sugar.sample(a.pos));
    
       // tumbling behavior:
			a.vel
        .rotate(srandom())
        .len(0.002);
		
		// remember for the next time:
		a.sense_memory = sense;
		
		// extract from world:
		sugar.deposit(-sense, a.pos);
		
		// leave trail:
		food_phero.deposit(1, a.pos);
		
		// locomotion
		a.pos.add(a.vel).wrap(1);
	}
}
  
function draw() {
	draw2D.blend(true);	
		draw2D.color("green").alpha(0.2);
		food_phero.draw();
		// draw field
		draw2D.color("yellow");
		sugar.draw();
		// draw home:
		draw2D.color("darkred").circle(nest.pos, nest.size);
	draw2D.blend(false);
	
	// draw agents
	for (var a of agents) {
		draw2D.push().translate(a.pos).rotate(a.vel).scale(a.size);
		// body
		draw2D.color("darkred")
			.circle([0.3, 0]).circle([-0.3, 0]);
		// sensor (shows current state by color)
		draw2D.color(1-a.sense_memory, a.sense_memory, 0.5)
		  .circle([0.3, 0.], 0.7);
		draw2D.pop();
	}
}
    </script>
  </body>
</html>