<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Flickr example</title>
    <script src="jquery-1.11.2.min.js"></script>
    <style>
body {
	height: 100%;
  	margin: 0;
  	padding: 0 2%;
  	
  	background: #888;
  	
  	font-family: Arial, sans-serif;
	font-size: 2em;
	color: #fff;
	text-shadow: 0 0 10px #000;
}

#main {
	min-height: 100%;
}

input {
	float: right;
}

footer{
	position: absolute;
	bottom: 0;
	
	font-size: 0.5em;
}

a {
	color: #fff;
}


    </style>
</head>
<body>
	<header>
		<form action="flickr.html">
			<input type="text" name="city">
		</form>
	</header>
	<div id="main">
	<section>
		<h1 id="city">City name</h1>
		<p id="weather">Info</p>
		<p id="temperature">Temp</p>
		<div id="images"></div>
	</section>
	</div>
	<footer>
		<p>This app is powered by <a href="http://flickr.com/services/api/">Flickr</a> but is not endorsed or certified by Flickr.</p>
	</footer>
	
	
    <script>

// please use your own -- not mine!!
var api_key = "c94edb150e81ffd150d703d66e5ad0a0";
var api_secret = "f6c81dd818e98b43";

// 0 <= result < limit
function rand(limit) {
    return Math.floor(Math.random() * limit);
}

// found here: http://css-tricks.com/snippets/javascript/get-url-variables/
function getQueryVariable(variable) {
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return decodeURIComponent(pair[1]);}
       }
       return false;
}

$(document).ready(function() {
	
	var position = {};
	
	var city = getQueryVariable("city") || "Toronto";
	
	function getimage(lon, lat, tags) {
		// see Flickr API here: https://www.flickr.com/services/api/flickr.photos.search.html
		
		var params = {
			// API basics:
			method: "flickr.photos.search",
			format: "json",
			api_key: api_key,
			// criteria:
			lon: lon,
			lat: lat,
			tags: tags,	// comma delimited
			tagmode: "all", // "any" or "all"
			accuracy: 1,
			sort: "relevance",
			extras: "url_l",
		};
		var url = "https://api.flickr.com/services/rest/?" + $.param(params)
			+ "&jsoncallback=?"
		;
		console.log(url);
		// using jQuery's getJSON, which wraps XMLHttpRequest for us
		// and means we don't have to worry about the JSONP results
		// and it also converts the response to an object for us
		$.getJSON(url, function(data) {
			if (data.photos.pages > 0){
				//console.log(data.photos);
				
				var item = data.photos.photo[rand(data.photos.photo.length)];
				console.log(item);
				
				// use this image as the background:
				$("body").css({
					"backgroundImage": "url("+item.url_l+")",      			
					"background-repeat": "no-repeat",
					"background-attachment": "fixed",
					"background-size": "cover",
				});
			}
		});
		
		/*
		var url = "http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?";
		
		//var url = "https://api.flickr.com/services/rest/?jsoncallback=?";
		$.getJSON( url, {
 			method: "flickr.photos.search",
			api_key: api_key,
			//lon: lon,
			//lat: lat,
			tags: tags,	// comma delimited
			//accuracy: 1,
			//extras: "url_l",
			sort: "relevance",
			tagmode: "all", // "any" or "all"
			format: "json"
		})
    	.done(function( data ) {
      		console.log(data);
      		
      		var item = data.items[rand(data.items.length)];
      		//$( "<img>" ).attr( "src", item.media.m ).appendTo( "#images" );
      		
      		$("body").css({
      			"backgroundImage": "url("+item.media.m+")",      			
				"background-repeat": "no-repeat",
				"background-attachment": "fixed",
				"background-size": "cover",
      		});
      		
      		
    	});
    	*/
	}
	
	function getweather() {
		var req = new XMLHttpRequest();
		req.open("GET", "http://api.openweathermap.org/data/2.5/weather?q=" + city, true);
		req.onreadystatechange = function () {
			var data, s, tags;
			var descriptions = [];
			// handle possible errors:
			if (this.status == 404) {
				console.log("URL not found\n");
				return;
			} else if (this.status != 200) {
				console.log("bad status:" + this.status + "\n");
				return;
			} 
			if (this.readyState == 4) {
				data = JSON.parse(this.responseText);
				
				console.log(data);
				
				// add to HTML:
				$("#city").text(data.name);
				
				// convert descriptions array into a string:
				for (var i=0; i<data.weather.length; i++) {
					descriptions.push(
						data.weather[i].description
					);
				}
				s = descriptions.join(", ");
				s = s.charAt(0).toUpperCase() + s.slice(1);
				$("#weather").text(s);
		
				$("#temperature").html(
					(data.main.temp - 273.15).toFixed(1) + " &deg;C"
				);
				
				tags = data.name + "," + descriptions.join(",");
				tags = tags.replace(" ", ",");
				console.log(tags);
				
				// now use the data:
				position.lon = data.coord.lon;
				position.lat = data.coord.lat;
				getimage(data.coord.lon, data.coord.lat, tags);
			}
		};
		req.send();
	};
	
	getweather();
	
});

    </script>
</body>
</html>